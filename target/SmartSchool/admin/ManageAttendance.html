<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart School System - Manage Attendance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/validate.css">
    <link rel="stylesheet" href="../assets/css/classList.css">
    <style>
        .filter-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .btn-delete-bulk { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; color: white; font-weight: bold; }
        .btn-month { background-color: #ff9800; }
        .btn-year { background-color: #f44336; }
        .date-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .btn-delete-day { color: #f44336; cursor: pointer; background: none; border: none; font-size: 14px; }
        .btn-second { background-color: black; color: white; padding: 12px 35px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-left">
            <i class="fas fa-bars menu-toggle-icon" id="menu-toggle"></i> <span>Smart School System</span>
        </div>
        <div class="header-right">
            <div class="profile-area" id="profileBtn">
                <span class="user-name">Admin</span> <img src="../assets/image/adminICON.png" alt="Admin" class="profile-image">
            </div>
            <div class="profile-menu" id="profileMenu">
                <p onclick="location.href='adminProfile.html'"><i class="fas fa-user"></i> My Profile</p>
                <p id="logoutOption"><i class="fas fa-sign-out-alt"></i> Logout</p>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li><a href="adminHomepage.html" class="menu-item"><i class="fas fa-home icon"></i> <span class="link-text">Home</span></a></li>
                <li><a href="class.html" class="menu-item active"><i class="fas fa-chalkboard icon"></i> <span class="link-text">Class</span></a></li>
                <li><a href="student.html" class="menu-item"><i class="fas fa-user-graduate icon"></i> <span class="link-text">Student</span></a></li>
                <li><a href="validateTeacher.html" class="menu-item"><i class="fas fa-user-check icon"></i> <span class="link-text">Validate</span></a></li>
                <li><a href="teacherList.html" class="menu-item"><i class="fas fa-users-rectangle icon"></i> <span class="link-text">Teacher List</span></a></li>
                <li><a href="assignment.html" class="menu-item"><i class="fas fa-tasks icon"></i> <span class="link-text">Assignment</span></a></li>
                <li><a href="adminSettings.html" class="menu-item"><i class="fas fa-cog icon"></i> <span class="link-text">Settings</span></a></li>
            </ul>
        </aside>

        <main class="content">
            <div class="breadcrumb">
                Hi, Admin <span class="breadcrumb-separator">&gt;</span> 
                <a href="class.html" style="color: inherit; text-decoration: none;">Class</a> 
                <span class="breadcrumb-separator">&gt;</span> 
                <span class="current-page">Manage Attendance: <span id="classNameDisplay">Loading...</span></span>
            </div>

            <div class="attendance-container">
                <div class="filter-section">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        
                        <label>Month:</label> 
                        <select id="monthSelect" onchange="loadAttendanceData()">
                            <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                            <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                            <option value="07">July</option><option value="08">August</option><option value="09">September</option>
                            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                        </select> 
                        
                        <label>Year:</label> 
                        <select id="yearSelect" onchange="loadAttendanceData()">
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>

                        <div style="flex-grow: 1; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn-delete-bulk btn-month" onclick="confirmDelete('month')">
                                <i class="fas fa-calendar-minus"></i> Delete Entire Month
                            </button>
                            <button type="button" class="btn-delete-bulk btn-year" onclick="confirmDelete('year')">
                                <i class="fas fa-trash-alt"></i> Delete Whole Year
                            </button>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;" id="historyTitle">Attendance History</h3>
                
                <div id="attendanceList" style="border: 1px solid #eee; border-radius: 8px;">
                    </div>

                <div style="margin-top: 25px; display: flex; justify-content: flex-end;">
                    <button type="button" class="btn-second" onclick="location.href='class.html'">
                        Back
                    </button>
                </div>
            </div>
        </main>
    </div>

    <form id="deleteForm" action="../DeleteAttendanceServlet" method="POST">
        <input type="hidden" name="classId" id="formClassId">
        <input type="hidden" name="mode" id="deleteMode">
        <input type="hidden" name="value" id="deleteValue">
    </form>

    <div id="bulkDeleteModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="bulkDeleteTitle" style="color: black;">Confirm</h3>
            <p id="bulkDeleteMessage"></p>
            <p style="font-size: 0.85rem; color: #666; margin-top: 10px; font-weight: bold;">This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="closeBulkDeleteModal()">Cancel</button>
                <button class="modal-btn btn-reject" id="confirmBulkDeleteBtn" style="background-color: #d93025;">Delete</button>
            </div>
        </div>
    </div>

    <div id="logoutModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Confirm Logout</h3>
            <p>Do you want to logout?</p>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" id="cancelLogout">Cancel</button>
                <button class="modal-btn btn-reject" id="confirmLogout">Logout</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INITIALIZATION ---
        const urlParams = new URLSearchParams(window.location.search);
        const classId = urlParams.get('classId');

        window.onload = function() {
            if (!classId) {
                alert("No Class ID provided!");
                window.location.href = "class.html";
                return;
            }
            loadAttendanceData();
        };

        // --- 2. DATA FETCHING ---
        function loadAttendanceData() {
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;

            fetch(`ManageAttendanceServlet?action=getData&classId=${classId}&month=${month}&year=${year}`)
                .then(response => response.json())
                .then(data => {
                    // Update Header
                    document.getElementById('classNameDisplay').innerText = data.className;
                    
                    // Update Dropdowns (Sync with server state)
                    document.getElementById('monthSelect').value = data.selectedMonth;
                    document.getElementById('yearSelect').value = data.selectedYear;

                    // Update Title
                    const monthName = document.getElementById('monthSelect').options[document.getElementById('monthSelect').selectedIndex].text;
                    document.getElementById('historyTitle').innerText = `Attendance History for ${monthName}`;

                    // Render List
                    renderList(data.dates);
                })
                .catch(err => console.error("Error loading attendance:", err));
        }

        function renderList(dates) {
            const container = document.getElementById('attendanceList');
            container.innerHTML = '';

            if (dates.length === 0) {
                container.innerHTML = `<p style="padding: 20px; color: #999; text-align: center;">No records found for this period.</p>`;
                return;
            }

            dates.forEach(date => {
                const row = `
                    <div class="date-row">
                        <span><i class="fas fa-clock"></i> <strong>${date}</strong></span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-delete-day" onclick="confirmDelete('day', '${date}')">
                                <i class="fas fa-times-circle"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += row;
            });
        }

        // --- 3. DELETE LOGIC ---
        let currentDeleteMode = null;
        let currentDeleteValue = null;

        function confirmDelete(mode, dateVal) {
            currentDeleteMode = mode;
            
            // If deleting day, value is the date. If month/year, value is selected dropdown.
            if (mode === 'day') currentDeleteValue = dateVal;
            else if (mode === 'month') currentDeleteValue = document.getElementById('monthSelect').value;
            else if (mode === 'year') currentDeleteValue = document.getElementById('yearSelect').value;

            const title = document.getElementById('bulkDeleteTitle');
            const message = document.getElementById('bulkDeleteMessage');
            const modal = document.getElementById('bulkDeleteModal');

            if (mode === 'day') {
                title.innerText = "Delete Day Attendance";
                message.innerText = "Are you sure you want to delete attendance for " + currentDeleteValue + "?";
            } else if (mode === 'month') {
                title.innerText = "Delete Entire Month";
                message.innerText = "WARNING: Delete ALL attendance records for this month?";
            } else if (mode === 'year') {
                title.innerText = "Delete Whole Year";
                message.innerText = "CRITICAL: Wipe entire attendance history for " + currentDeleteValue + "?";
            }

            modal.style.display = 'flex';
        }

        function closeBulkDeleteModal() {
            document.getElementById('bulkDeleteModal').style.display = 'none';
        }

        document.getElementById('confirmBulkDeleteBtn').addEventListener('click', function() {
            if (currentDeleteMode && currentDeleteValue) {
                // Fill hidden form and submit to LEGACY Servlet
                document.getElementById('formClassId').value = classId;
                document.getElementById('deleteMode').value = currentDeleteMode;
                document.getElementById('deleteValue').value = currentDeleteValue;
                document.getElementById('deleteForm').submit();
            }
        });

        // --- 4. UI UTILS ---
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        if(menuToggle) menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));

        const profileBtn = document.getElementById('profileBtn');
        const profileMenu = document.getElementById('profileMenu');
        if(profileBtn) profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block'; });
        window.addEventListener('click', () => { if(profileMenu) profileMenu.style.display = 'none'; });

        const logoutOption = document.getElementById('logoutOption');
        const logoutModal = document.getElementById('logoutModal');
        const cancelLogout = document.getElementById('cancelLogout');
        const confirmLogout = document.getElementById('confirmLogout');
        if(logoutOption) logoutOption.addEventListener('click', () => logoutModal.style.display = 'flex');
        if(cancelLogout) cancelLogout.addEventListener('click', () => logoutModal.style.display = 'none');
        if(confirmLogout) confirmLogout.addEventListener('click', () => window.location.href = '../LogoutServlet');

    </script>
</body>
</html>